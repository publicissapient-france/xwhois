var assert = require('assert'),
    sinon = require('sinon'),
    confluence = require('../../../src/api/infrastructure/confluence'),
    trombinoscopeDb = require('../../../src/api/infrastructure/trombinoscopeDb'),
    trombinoscope = require('../../../src/api/trombinoscope');

describe('Trombinoscope Module Test', function () {
    var confluenceContentStub, confluenceAttachmentsStub, confluenceDownloadStub, trombinoscopeDbLastModifiedDateStub, trombinoscopeDbUpdatePersonStub, trombinoscopeDbUpdateLastModifiedDateStub, previousProcessEnvTITLE,

        assertThat = function (actual) {
            return {
                'hasName': function (expected, message) {
                    assert.strictEqual(actual['name'], expected, message === undefined ? 'person\'s name' : message);
                    return this;
                },
                'hasLastModificationDate': function (expected) {
                    assert.strictEqual(actual['lastModifiedDate'], expected, 'last modified date of image of parsed person');
                    return this;
                },
                'filenameIsUndefined': function () {
                    assert.strictEqual(actual['filename'], undefined, 'filename of image of parsed person');
                    return this;
                },
                'hrefIsUndefined': function () {
                    assert.strictEqual(actual['href'], undefined, 'href of image of parsed person');
                    return this;
                }

            };
        };

    beforeEach(function (done) {
        confluenceContentStub = sinon.stub(confluence, 'content');
        confluenceAttachmentsStub = sinon.stub(confluence, 'attachments');
        confluenceDownloadStub = sinon.stub(confluence, 'download');
        trombinoscopeDbLastModifiedDateStub = sinon.stub(trombinoscopeDb, 'getLastModifiedDate');
        trombinoscopeDbUpdatePersonStub = sinon.stub(trombinoscopeDb, 'updatePerson');
        trombinoscopeDbUpdateLastModifiedDateStub = sinon.stub(trombinoscopeDb, 'updateLastModifiedDate');
        previousProcessEnvTITLE = process.env.TITLE;
        process.env.TITLE = 'Child1';
        done();
    });

    afterEach(function (done) {
        trombinoscope.reset();
        confluenceContentStub.restore();
        confluenceAttachmentsStub.restore();
        confluenceDownloadStub.restore();
        trombinoscopeDbLastModifiedDateStub.restore();
        trombinoscopeDbUpdatePersonStub.restore();
        trombinoscopeDbUpdateLastModifiedDateStub.restore();
        if (previousProcessEnvTITLE === undefined) {
            delete process.env.TITLE;
        } else {
            process.env.TITLE = previousProcessEnvTITLE;
        }
        done();
    });

    it('should get list of users with their photos', function () {
        confluenceContentStub.yieldsOn(trombinoscope, '<?xml version="1.0" encoding="UTF-8" standalone="yes"?><content type="page" expand="space,children,comments,attachments,labels" id="4522409"><link rel="alternate" type="text/html" href="https://host/confluence/display/space"/><link rel="alternate" type="application/pdf" href="https://host/confluence/spaces/flyingpdf/pdfpageexport.action?pageId=1234"/><link rel="self" href="https://host/confluence/rest/prototype/1/content/1234"/><title>space</title><parentId>123</parentId><wikiLink>[space]</wikiLink><lastModifiedDate date="2015-02-24T15:21:57+0100" friendly="févr. 24, 2015"/><createdDate date="2007-10-04T17:28:09+0200" friendly="oct. 04, 2007"/><space type="space" title="space" name="space" key="space"><link rel="self" href="https://host/confluence/rest/prototype/1/space/space"/></space><children size="0"/><comments total="0"/><body type="2">&lt;ac:macro ac:name=&quot;info&quot;&gt;&lt;ac:rich-text-body&gt;Ta photo n\'est pas sur le trombi et tu ne sais pas comment l\'ajouter au bon format ? Envoie la &amp;agrave; &lt;a href=&quot;mailto:admin@host&quot;&gt;Administrateur&lt;/a&gt;.&lt;/ac:rich-text-body&gt;&lt;/ac:macro&gt;&lt;h1&gt;Title 1&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file1.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname1 LASTNAME1&lt;/p&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;Role 1&lt;/p&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h1&gt;Title 2&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file2.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;p&gt;Firstname2 LAST&amp;Egrave;NAME2&lt;/p&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 2&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file3.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file4.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file5.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file6.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname3 LASTNAME3&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname4 LASTNAME4&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname5 LASTNAME5&lt;/span&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&amp;nbsp;Firstname6 LASTNAME6&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;Role 3&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;Role 4&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;p&gt;Role 5&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 6&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file7.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:height=&quot;267&quot; ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file8.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file9.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file10.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname7 LASTNAME7&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname8 LASTNAME8&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;First-name9 LASTNAME9&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname10 LA STNAME10&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;Role 7&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;Role 8&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;Role 9&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 10&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file11.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file12.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file13.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image ac:thumbnail=&quot;true&quot; ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file14.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;&lt;strong&gt; &lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firs&amp;ccedil;tname11 LASTNAME11&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname12 LASTNAME12&lt;/span&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname13&lt;/span&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt; LASTNAME13&lt;/span&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firs&lt;/span&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;-Name14 LASTNAME14&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;Role 11&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 12&lt;/span&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 13&lt;/span&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 14&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file15.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file16.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span&gt;Fir&amp;eacute;stname15 LASTNAME15&lt;/span&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;F&amp;eacute;irstname16 LA STNAME16&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td colspan=&quot;1&quot;&gt;Role 15&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;Role 16&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h1&gt;Title 3&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file17.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file18.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file19.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file20.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname17 LASTNAME17&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname18 LASTNAME18&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname19 LASTNAME19&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname20 LASTNAME20&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;Role 17&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;Role 18&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;Role 19&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;Role 20&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h1&gt;Title 4&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file21.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file22.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file23.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file24.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname21 LASTNAME21&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname22 LASTNAME22&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;F&amp;eacute;irstname23 LASTNAME23&lt;br /&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname24 LASTNAME24&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;Role 21&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;span&gt;Role 22&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;p&gt;&lt;span&gt;Role 23&lt;br /&gt;&lt;/span&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 24&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;h1&gt;Title 5&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file25.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file26.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file27.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file28.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;Firstname25 &lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;LASTNAME&amp;Eacute;&lt;/span&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;F&amp;eacute;irstname26 LASTNAME26&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname&amp;eacute; LASTNAME27&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;F&amp;eacute;ir&amp;iuml;stname LASTNAME28&lt;/th&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td&gt;Role 25&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;Role 26&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;Role 27&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;span&gt;Role 28&lt;/span&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;h1&gt;Title 6&lt;/h1&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file29.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file30.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file31.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file32.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname29 LASTNAME29&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname30 LASTNAME30&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname31 LA STNAME31&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firs&amp;egrave;stname32 LAS- TNAME32&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file33.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file34.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file35.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file36.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname33 LASTNAME33&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname34 LASTNAME34&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname (Firstn) LASTNAME35&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;Firstname36 LASTNAME36&lt;/th&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image ac:thumbnail=&quot;true&quot; ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file37.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:url ri:value=&quot;https://host/confluence/download/attachments/1234/file38.jpg?version=1&amp;amp;modificationDate=1387021227752&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td&gt;&lt;p&gt;&lt;ac:image&gt;&lt;ri:attachment ri:filename=&quot;file39.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/p&gt;&lt;/td&gt;&lt;td colspan=&quot;1&quot;&gt;&lt;ac:image ac:width=&quot;200&quot;&gt;&lt;ri:attachment ri:filename=&quot;file40.jpg&quot; /&gt;&lt;/ac:image&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;th&gt;&lt;p&gt;Firstname37 Lastname37&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname38 LASTNAME38&lt;/span&gt;&lt;/p&gt;&lt;/th&gt;&lt;th&gt;&lt;p&gt;Firstname39 LASTNAME39&lt;/p&gt;&lt;/th&gt;&lt;th colspan=&quot;1&quot;&gt;&lt;span style=&quot;color: rgb(0,51,102);&quot;&gt;Firstname40 LASTNAME40&lt;/span&gt;&lt;/th&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;&lt;/div&gt;&lt;p&gt;&amp;nbsp;&lt;/p&gt;</body><attachments size="323"/><labels><label name="label" namespace="global"/></labels><creator><links rel="self" href="https://host/confluence/rest/prototype/1/user/non-system/creatoruid"/><name>creatoruid</name><displayName>Creator</displayName><displayableEmail>nothing@provider.com</displayableEmail><anonymous>false</anonymous></creator><lastModifier><links rel="self" href="https://host/confluence/rest/prototype/1/user/non-system/lastmodifieruid"/><name>lastmodifieruid</name><displayName>Last Modifier UID</displayName><displayableEmail>lastmodifieruid@provider.com</displayableEmail><anonymous>false</anonymous></lastModifier></content>');
        confluenceAttachmentsStub.yields('<?xml version="1.0" encoding="UTF-8" standalone="yes"?><attachments size="40" expand="attachment"><attachment iconClass="content-type-attachment-image" niceType="Image" version="1" niceFileSize="21 kB" fileSize="21524" contentType="image/jpeg" fileName="file1.jpg" type="attachment" id="55672963"><ownerId>4522409</ownerId><parentTitle>Title</parentTitle><link rel="self" href="https://host/confluence/rest/prototype/1/attachment/55672963"/><link rel="download" type="image/jpeg" href="https://host/confluence/download/attachments/1234/file1.jpg?version=1&amp;modificationDate=1424787636276"/><link rel="alternate" type="text/html" href="https://host/confluence/pages/viewpageattachments.action?pageId=1234&amp;highlight=file1#Title-attachment-file1.jpg"/><title>file1</title><thumbnailLink rel="thumbnail" href="https://host/confluence/download/thumbnails/1234/file1.jpg"/><thumbnailWidth>153</thumbnailWidth><thumbnailHeight>200</thumbnailHeight><wikiLink>[space:Title^file1.jpg]</wikiLink><space type="space" title="Space" name="Space" key="space"><link rel="self" href="https://host/confluence/rest/prototype/1/space/space"/></space><lastModifiedDate date="2015-02-24T15:20:36+0100" friendly="févr. 24, 2015"/><createdDate date="2015-02-24T15:20:36+0100" friendly="févr. 24, 2015"/></attachment><attachment fileName="file2.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file2.jpg?version=1&amp;modificationDate=1424269877582"/><title>file2.jpg</title></attachment><attachment fileName="file3.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file3.jpg?version=1&amp;modificationDate=1424269377993"/><title>file3.jpg</title></attachment><attachment fileName="file4.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file4.jpg?version=1&amp;modificationDate=1422814022360"/><title>file4.jpg</title></attachment><attachment fileName="file5.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file5.jpg?version=1&amp;modificationDate=1421420773174"/><title>file5.jpg</title></attachment><attachment fileName="file6.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file6.jpg?version=1&amp;modificationDate=1421420031657"/><title>file6.jpg</title></attachment><attachment fileName="file7.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file7.jpg?version=1&amp;modificationDate=1420822681305"/><title>file7.jpg</title></attachment><attachment fileName="file8.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file8.jpg?version=1&amp;modificationDate=1420822489629"/><title>file8.jpg</title></attachment><attachment fileName="file9.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file9.jpg?version=1&amp;modificationDate=1420822087847"/><title>file9.jpg</title></attachment><attachment fileName="file10.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file10.jpg?version=1&amp;modificationDate=1418400585368"/><title>file10.jpg</title></attachment><attachment fileName="file11.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file11.jpg?version=1&amp;modificationDate=1416238194303"/><title>file11.jpg</title></attachment><attachment fileName="file12.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file12.jpg?version=1&amp;modificationDate=1415895956840"/><title>file12.jpg</title></attachment><attachment fileName="file13.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file13.jpg?version=1&amp;modificationDate=1415895933868"/><title>file13.jpg</title></attachment><attachment fileName="file14.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file14.jpg?version=1&amp;modificationDate=1415892529114"/><title>file14.jpg</title></attachment><attachment fileName="file15.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file15.jpg?version=1&amp;modificationDate=1415891156480"/><title>file15.jpg</title></attachment><attachment fileName="file16.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file16.jpg?version=1&amp;modificationDate=1415890996245"/><title>file16.jpg</title></attachment><attachment fileName="file17.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file17.jpg?version=1&amp;modificationDate=1415890762332"/><title>file17.jpg</title></attachment><attachment fileName="file18.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file18.jpg?version=1&amp;modificationDate=1413536400239"/><title>file18.jpg</title></attachment><attachment fileName="file19.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file19.jpg?version=1&amp;modificationDate=1413473242204"/><title>file19.jpg</title></attachment><attachment fileName="file20.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file20.jpg?version=1&amp;modificationDate=1413363104671"/><title>file20.jpg</title></attachment><attachment fileName="file21.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file21.jpg?version=1&amp;modificationDate=1413303714343"/><title>file21.jpg</title></attachment><attachment fileName="file22.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file22.jpg?version=1&amp;modificationDate=1413281856957"/><title>file22.jpg</title></attachment><attachment fileName="file23.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file23.jpg?version=1&amp;modificationDate=1413280872330"/><title>file23.jpg</title></attachment><attachment fileName="file24.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file24.jpg?version=1&amp;modificationDate=1413228503594"/><title>file24.jpg</title></attachment><attachment fileName="file25.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file25.jpg?version=1&amp;modificationDate=1413228386188"/><title>file25.jpg</title></attachment><attachment fileName="file26.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file26.jpg?version=1&amp;modificationDate=1410191356685"/><title>file26.jpg</title></attachment><attachment fileName="file27.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file27.jpg?version=1&amp;modificationDate=1410191168439"/><title>file27.jpg</title></attachment><attachment fileName="file28.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file28.jpg?version=1&amp;modificationDate=1406619599753"/><title>file28.jpg</title></attachment><attachment fileName="file29.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file29.jpg?version=1&amp;modificationDate=1405087278062"/><title>file29.jpg</title></attachment><attachment fileName="file30.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file30.jpg?version=1&amp;modificationDate=1404978581242"/><title>file30.jpg</title></attachment><attachment fileName="file31.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file31.jpg?version=1&amp;modificationDate=1404978404456"/><title>file31.jpg</title></attachment><attachment fileName="file32.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file32.jpg?version=1&amp;modificationDate=1404805554216"/><title>file32.jpg</title></attachment><attachment fileName="file33.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file33.jpg?version=1&amp;modificationDate=1404561550619"/><title>file33.jpg</title></attachment><attachment fileName="file34.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file34.jpg?version=1&amp;modificationDate=1404464552409"/><title>file34.jpg</title></attachment><attachment fileName="file35.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file35.jpg?version=1&amp;modificationDate=1404464400260"/><title>file35.jpg</title></attachment><attachment fileName="file36.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file36.jpg?version=1&amp;modificationDate=1404464212179"/><title>file36.jpg</title></attachment><attachment fileName="file37.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file37.jpg?version=1&amp;modificationDate=1403266666655"/><title>file37.jpg</title></attachment><attachment fileName="file38.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file38.jpg?version=1&amp;modificationDate=1403266631170"/><title>file38.jpg</title></attachment><attachment fileName="file39.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file39.jpg?version=1&amp;modificationDate=1401976339018"/><title>file39.jpg</title></attachment><attachment fileName="file40.jpg"><link rel="download" href="https://host/confluence/download/attachments/1234/file40.jpg?version=1&amp;modificationDate=1400594262618"/><title>file40.jpg</title></attachment></attachments>');
        confluenceDownloadStub.yields('jpeg...');

        trombinoscope.parsePeople();

        assertThat(trombinoscope.getPerson(0))
            .hasName('Firstname1 LASTNAME1')
            .hasLastModificationDate('2015-02-24T15:20:36+0100')
            .filenameIsUndefined()
            .hrefIsUndefined();
        assert(trombinoscope.getPerson(0)['imageAsByteArray'].equals(new Buffer('jpeg...')), 'actual image as byte array is not equal to subbed content');
        assert(trombinoscopeDbUpdatePersonStub.getCall(0).calledWithExactly(trombinoscope.getPerson(0)), 'first person should be updated to database');
        assertThat(trombinoscope.getPerson(31)).hasName('Firs&#xE8;stname32 LAS- TNAME32', 'name that contains html entity, space and minus');
        assertThat(trombinoscope.getPerson(34)).hasName('Firstname (Firstn) LASTNAME35', 'name that contains parenthesis');
        assertThat(trombinoscope.getPerson(37)).hrefIsUndefined();
        assert.strictEqual(trombinoscope.people.length, 40, 'number of parsed people');
        assert(trombinoscopeDbUpdateLastModifiedDateStub.calledWithExactly(new Date('2015-02-24T15:21:57+0100')), 'once downloaded and parsed, last modified date from confluence shoulb be written to database');
    });

    it('should not update because last modified date from database is same as last modified date from confluence', function () {
        var lastModifiedDate = '1981-12-24T09:30:00+0100';
        trombinoscopeDbLastModifiedDateStub.returns(new Date(lastModifiedDate));
        confluenceContentStub.yieldsOn(trombinoscope, '<content><lastModifiedDate date="' + lastModifiedDate + '"/></content>');

        trombinoscope.parsePeople();

        assert.strictEqual(trombinoscope.people.length, 0);
    });
});
